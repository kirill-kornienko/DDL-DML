# Домашнее задание к занятию «Резервное копирование баз данных» - `Корниенко Кирилл`


### Задание 1. Резервное копирование

### Кейс


Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.

Необходимо описать, какие варианты резервного копирования подходят в случаях:

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

### *Решение*

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

Для выполнения этой задачи требуется стратегия, которая гарантирует наличие полной копии данных на момент окончания предыдущего дня (например, на 23:59:59 вчерашнего дня). Наилучшим вариантом будет комбинация полного (Full) и дифференциального (Differential) резервного копирования, либо просто ежедневное полное копирование.

### Рекомендуемый вариант: 
Полное  резервное копирование ночью(Full Backup) + Дифференциальное (Differential Backup) в течение дня (опционально).

Как это работает:

Полное резервное копирование: Выполняется один раз в сутки, например, в 00:00 часов. Эта копия содержит 100% всех данных на момент начала суток.

Восстановление: Для получения полного объёма данных за предыдущий день достаточно развернуть единственный файл — полную копию, сделанную в начале этих суток.

### Почему это подходит:

Целостность: Полная копия на начало суток гарантирует состояние системы на этот момент.

Простота и скорость восстановления: В случае сбоя администратору не нужно применять несколько разных архивов (как в случае с инкрементными копиями), достаточно одного бэкапа. Это полностью соответствует требованию «полный объём за предыдущий день».

Альтернатива (если нужно хранить историю и экономить место):
Можно использовать схему Full + Differential. Например, полный бэкап делается в воскресенье, а с понедельника по субботу делаются дифференциальные копии (сохраняющие все изменения с воскресенья). Для восстановления данных за пятницу потребуется восстановить воскресный Full + пятничный Differential. Это также дает полный объём на конец конкретного дня, но экономит дисковое пространство по сравнению с ежедневными полными копиями.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

Если данных не много и интенсивность использования низкая, то полное резервное копирование каждый день с дифференциальным бэкапом каждый час. Этот вариант надежнее, но использует больше места для хранения.
Если данных много и интенсивность использования высокая, то полное резервное копирование каждый день с инкрементным бэкапом каждый час. Этот вариант менее надежный, но использует меньше места для хранения.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

Да, возможен. Репликация. В случае поломки БД и остановки мастер-сервера можно назначить «новым мастер-сервером»  один из слейв-серверов и перенаправить клиентов на него. После устранения неисправностей делается обратное переназначение и перенаправление.

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

*Приведите ответ в свободной форме.*

### Решение:

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

Команда резервирования данных:

```bash
pg_dump sakila > sakiladb.sql
```

Если нужен другой формат, то указываем параметр -Fc:

```bash
pg_dump -Fc sakila > sakiladb.dump
```

Если БД принадлежит другому пользователю, то указываем параметр -U username:

```bash
pg_dump -U username sakila > sakiladb.sql
```

[Ссылка на документацию PostgreSQL, pg_dump](https://www.postgresql.org/docs/current/app-pgdump.html)

Команда восстановления БД:

```bash
pg_restore -d sakila sakiladb.sql
```

[Ссылка на документацию PostgreSQL, pg_restore](https://www.postgresql.org/docs/current/app-pgrestore.html)

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.

*Приведите ответ в свободной форме.*

### Решение:

Так как инкрементное резервное копирование использует полную копию как начальную точку, то сначала нужно сделать полную резервную копию. Далее инкрементное резервное копирование:

```bash
mysqlbackup --defaults-file=/home/dbadmin/my.cnf \
  --incremental --incremental-base=history:last_backup \
  --backup-dir=/home/dbadmin/temp_dir \
  --backup-image=incremental_image1.bi \
   backup-to-image
```

В данном примере используется опция --incremental-base=history:last_backup, которая извлекает LSN последней успешной полной или частичной резервной копии (не TTS) из mysql.backup_history таблицы и на этой основе выполняет инкрементную резервную копию.

[Ссылка на документацию MySQL](https://dev.mysql.com/doc/mysql-enterprise-backup/8.2/en/mysqlbackup.incremental.html#meb-incremental-considerations)
